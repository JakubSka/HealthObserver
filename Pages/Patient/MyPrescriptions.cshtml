@page
@using HealthObserver.Models
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using HealthObserver.Data.Migrations
@model HealthObserver.Pages.Patient.MyPrescriptionsModel
@inject UserManager<ApplicationUser> UserManager
@{
	ViewData["Title"] = "My Prescriptions";
}

@if (TempData["ShowAlert"] != null && (bool)TempData["ShowAlert"])
{
	<div class="overlay">
		<div class="alert-container">
			<div class="alert alert-@TempData["AlertType"]">
				<span class="close-btn" onclick="closeAlert()">×</span>
				@TempData["AlertMessage"]
			</div>
		</div>
	</div>
	<script>
		function closeAlert() {
			document.querySelector('.overlay').style.display = 'none';
		}
	</script>
}
@{
	var currentUser = await UserManager.GetUserAsync(User);
}
<div class="bg-light p-4 ">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
			<li class="nav-item" role="presentation">
				<a class="nav-link active" id="pills-prescriptions-tab" data-bs-toggle="pill" href="#pills-prescriptions" role="tab" aria-controls="pills-prescriptions" aria-selected="true">My Prescriptions</a>
			</li>
			<li class="nav-item" role="presentation">
				<a class="nav-link" id="pills-medication-tab" data-bs-toggle="pill" href="#pills-medication" role="tab" aria-controls="pills-medication" aria-selected="false">Medication Tracking</a>
			</li>
		</ul>
		<div>
			<a href="@Url.Page("/Doctor/Prescription/HistoryPrescription", new { userId = @currentUser.Id })" class="btn custom-btn-primary">Prescription History</a>
		</div>
	</div>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-prescriptions" role="tabpanel" aria-labelledby="pills-prescriptions-tab">
            <div class="table-container">
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col" class="text-center">Medicine</th>
                            <th scope="col" class="text-center">Description</th>
                            <th scope="col" class="text-center">Dose</th>
                            <th scope="col" class="text-center">Dose Unit</th>
                            <th scope="col" class="text-center">Frequency</th>
                            <th scope="col" class="text-center">StartPrescription</th>
                            <th scope="col" class="text-center">EndPrescription</th>
                            <th scope="col" class="text-center">Option</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Prescriptions.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center">No prescriptions found.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var prescription in Model.Prescriptions)
                            {
                                <tr>
                                    <td class="text-center">@prescription.Medicine.Name</td>
                                    <td class="text-center">@prescription.Medicine.Description</td>
                                    <td class="text-center">@prescription.Dose</td>
                                    <td class="text-center">@prescription.DoseUnit</td>
                                    <td class="text-center">@prescription.FrequencyInHours</td>
                                    <td class="text-center">@prescription.StartPrescription.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">@prescription.EndPrescription.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">
                                        <button class="btn custom-btn-primary" onclick="openCreateModal(this)" data-prescription-id="@prescription.PrescriptionId">Add Amount Taken</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane fade" id="pills-medication" role="tabpanel" aria-labelledby="pills-medication-tab">
            <div class="table-container">
                <table class="table table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col" class="text-center">Date Taken</th>
                            <th scope="col" class="text-center">StartPrescription</th>
                            <th scope="col" class="text-center">EndPrescription</th>
                            <th scope="col" class="text-center">Medicine</th>
                            <th scope="col" class="text-center">Amount Taken</th>
                            <th scope="col" class="text-center">Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.MedicationHistory.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center">No medication tracking history found.</td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var history in Model.MedicationHistory)
                            {
                                <tr>
                                    <td class="text-center">@history.TakenDateTime.Date.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">@history.Prescription.StartPrescription.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">@history.Prescription.EndPrescription.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">@history.Prescription.Medicine.Name - @history.Prescription.Dose @history.Prescription.DoseUnit</td>
                                    <td class="text-center">
                                        @if (history.AmountTaken == 0)
                                        {
                                            <span style="color: red;">@history.AmountTaken</span>
                                        }
                                        else if (history.AmountTaken != history.Prescription.Dose)
                                        {
                                            <span style="color: darkorange;">@history.AmountTaken</span>
                                        }
                                        else
                                        {
                                            <span style="color: green;">@history.AmountTaken</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button amount_taken="@history.AmountTaken" class="btn custom-btn-primary" onclick="openEditModal('@history.MedicationHistoryId')">Edit Amount Taken</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>


</div>

	<div class="modal fade" id="editModal">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Edit Amount Taken</h4>
				</div>
				<div class="modal-body">
					<form id="editForm" method="post">
						<div class="form-group mt-2 row">
							<label class="control-label" for="AmountTaken">Amount Taken</label>
							<input class="form-control"  type="number" step="0.1" asp-for="AmountTaken" min="0" />
						</div>
						<div class="form-group mt-4">
							<button type="submit" class="btn custom-btn-primary w-100">Save Changes</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>




<div class="modal fade" id="createModal" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Add Amount Taken</h4>
			</div>
			<div class="modal-body">
				<form id="createForm" method="post">
					<input type="hidden" asp-for="SelectedPrescriptionId" />
					<div class="form-group mt-2 row">
						<label for="AmountTaken" class="control-label">Amount Taken:</label>
						<input class="form-control" type="number" step="0.1" asp-for="AmountTaken" min="0" />
					</div>
					<div class="form-group mt-2 row">
						<label for="TakenDateTime" class="control-label">DateTime:</label>
						<input class="form-control" type="date" asp-for="TakenDateTime" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
					</div>
					<div class="form-group mt-4">
						<button type="submit" class="btn custom-btn-success w-100">Add</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>


<script>

	function openCreateModal(button) {
		var form = document.getElementById('createForm');
		var prescriptionId = button.getAttribute('data-prescription-id');
		form.querySelector('[name="SelectedPrescriptionId"]').value = prescriptionId;
		$('#createModal').modal('show');
	}

	function openEditModal(historyId) {
		var form = document.getElementById('editForm');
		form.action = '/Patient/MyPrescriptions?handler=Edit&Id=' + historyId;
		$('#editModal').modal('show');
	}
</script>